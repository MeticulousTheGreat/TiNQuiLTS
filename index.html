<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TiNQuiLTS</title>
  <script src="https://cdn.jsdelivr.net/npm/abcjs/dist/abcjs-basic-min.min.js"></script>
  <script defer src="script.js"></script>
  now begins the synth script from https://paulrosen.github.io/abcjs/examples/synth-player.html

	<script type="text/javascript">

		var abc = 
			"T: Cooley's\n" +
			"M: 4/4\n" +
			"Q: 1/4=120\n" +
			"L: 1/8\n" +
			"R: reel\n" +
			"K: Emin\n" +
			"|:{E}D2|EB{c}BA B2 EB|~B2 AB dBAG|FDAD BDAD|FDAD dAFD|\n" +
			"EBBA B2 EB|B2 AB defg|afe^c dBAF|DEFD E2:|\n" +
			"|:gf|eB B2 efge|eB B2 gedB|A2 FA DAFA|A2 FA defg|\n" +
			"eB B2 eBgB|eB B2 defg|afe^c dBAF|DEFD E2:|"


		var abcOptions = {
			add_classes: true,
			responsive: "resize"
		};

		function CursorControl() {
			var self = this;

			self.onReady = function() {
			};
			self.onStart = function() {
				var svg = document.querySelector("#paper svg");
				var cursor = document.createElementNS("http://www.w3.org/2000/svg", "line");
				cursor.setAttribute("class", "abcjs-cursor");
				cursor.setAttributeNS(null, 'x1', 0);
				cursor.setAttributeNS(null, 'y1', 0);
				cursor.setAttributeNS(null, 'x2', 0);
				cursor.setAttributeNS(null, 'y2', 0);
				svg.appendChild(cursor);

			};
			self.beatSubdivisions = 2;
			self.onBeat = function(beatNumber, totalBeats, totalTime) {
			};
			self.onEvent = function(ev) {
				if (ev.measureStart && ev.left === null)
					return; // this was the second part of a tie across a measure line. Just ignore it.

				var lastSelection = document.querySelectorAll("#paper svg .highlight");
				for (var k = 0; k < lastSelection.length; k++)
					lastSelection[k].classList.remove("highlight");

				for (var i = 0; i < ev.elements.length; i++ ) {
					var note = ev.elements[i];
					for (var j = 0; j < note.length; j++) {
						note[j].classList.add("highlight");
					}
				}

				var cursor = document.querySelector("#paper svg .abcjs-cursor");
				if (cursor) {
					cursor.setAttribute("x1", ev.left - 2);
					cursor.setAttribute("x2", ev.left - 2);
					cursor.setAttribute("y1", ev.top);
					cursor.setAttribute("y2", ev.top + ev.height);
				}
			};
			self.onFinished = function() {
				var els = document.querySelectorAll("svg .highlight");
				for (var i = 0; i < els.length; i++ ) {
					els[i].classList.remove("highlight");
				}
				var cursor = document.querySelector("#paper svg .abcjs-cursor");
				if (cursor) {
					cursor.setAttribute("x1", 0);
					cursor.setAttribute("x2", 0);
					cursor.setAttribute("y1", 0);
					cursor.setAttribute("y2", 0);
				}
			};
		}

		var cursorControl = new CursorControl();

		var synthControl;

		function load() {
			if (ABCJS.synth.supportsAudio()) {
				synthControl = new ABCJS.synth.SynthController();
				synthControl.load("#audio", cursorControl, {displayLoop: true, displayRestart: true, displayPlay: true, displayProgress: true, displayWarp: true});
			} else {
				document.querySelector("#audio").innerHTML = "<div class='audio-error'>Audio is not supported in this browser.</div>";
			}
			setTune(false);
		}

		function setTune(userAction) {
			synthControl.disable(true);
			var visualObj = ABCJS.renderAbc("paper", abc, abcOptions)[0];

			var midiBuffer = new ABCJS.synth.CreateSynth();
			midiBuffer.init({
				visualObj: visualObj,
			}).then(function (response) {
				console.log(response);
				if (synthControl) {
					synthControl.setTune(visualObj, userAction).then(function (response) {
						console.log("Audio successfully loaded.")
					}).catch(function (error) {
						console.warn("Audio problem:", error);
					});
				}
			}).catch(function (error) {
				console.warn("Audio problem:", error);
			});
		}

	</script>  
  
  
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label { margin-right: 10px; }
    #output { margin-top: 40px; }
    #midiLink { margin-top: 10px; display: none; }
  </style>
</head>
<body>
  <h1>TiNQuiLTS Etude Generator</h1>

  <div>
    <label><strong>Keys:</strong></label><br/>
    <label><input type="checkbox" name="keys" value="C" style="font-weight:bold;"> C</label>
    <label><input type="checkbox" name="keys" value="G"> G</label>
    <label><input type="checkbox" name="keys" value="D"> D</label>
    <label><input type="checkbox" name="keys" value="A"> A</label>
    <label><input type="checkbox" name="keys" value="E"> E</label>
    <label><input type="checkbox" name="keys" value="B"> B</label>
    <label><input type="checkbox" name="keys" value="F#"> F#</label>
    <label><input type="checkbox" name="keys" value="Db"> Db</label>
    <label><input type="checkbox" name="keys" value="Ab"> Ab</label>
    <label><input type="checkbox" name="keys" value="Eb"> Eb</label>
    <label><input type="checkbox" name="keys" value="Bb"> Bb</label>
    <label><input type="checkbox" name="keys" value="F"> F</label>
    <label><input type="checkbox" name="keys" value="Chromatic"> Chromatic</label>
  </div>

  <br/>

  <label><input type="checkbox" id="useRhythms" checked> Use Rhythms</label>
  <label><input type="checkbox" id="doJumps"> Do Jumps</label>

  <br/><br/>

  <label>Number of Measures:</label>
  <input type="range" id="numMeasures" min="1" max="32" value="4" />
  <span id="measureValue">4</span>

  <br/><br/>

  <label>Octave Range:</label>
  <input type="range" id="octaveRange" min="1" max="4" step="0.25" value="2" />
  <span id="octaveRangeValue">2</span> octaves

  <br/><br/>

  <label>Center Octave:</label>
  <input type="range" id="centerOctave" min="-1" max="6" value="4" />
  <span id="centerOctaveValue">4</span>

  <br/><br/>

  <button id="generateBtn">Generate Etude</button> <br><br>
 
  Raw Notation Output:
  <p id="rawNotation"> (raw output here) </p>
  
  Final Notation Output:<br>
  <div id="paper"></div>
  <div id="audio"></div>

</body>
</html>
